<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://kit.fontawesome.com/my id.js" crossorigin="anonymous"></script>
<!-- breadcrumb -->
<div class="container">
  <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
    <a href="/cart" class="stext-109 cl8 hov-cl1 trans-04">
      cart
      <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
    </a>

    <span class="stext-109 cl4"> chekout </span>
  </div>
  <form id="coupon">
    <input type="hidden" value="<%=totalAmount %>" name="amount">
    <div class="input-group mb-3 couponInput">
      <input type="text" class="form-control " placeholder="coupen" aria-label="Recipient's username"
        aria-describedby="basic-addon2" name="couponCode">
        
      <div class="input-group-append">
        <% if (!coupon) { %>
          <button class="btn btn-dark" type="button" onclick="addCoupon()">add</button>
      <% } else { %>
        <button class="btn btn-danger" type="button" onclick="removeCoupon()">remove</button>
      <% } %>
      </div>
    </div>
  </form>

</div>


<!-- Shoping Cart -->
<form class="bg0 p-t-75 p-b-85" id="submitOrder">
  <div class="container">

    <div class="row">

      <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
        <div class="m-l-25 m-r--38 m-lr-0-xl" style="display: flex; flex-wrap: wrap; gap: 20px; color: black">
          <a href="/load-add-address?page=/chekout">
            <div class="addAddressInChek">
              <img src="/user/icon/Untitled.png" alt="" />
              <p style="
                  font-size: 30px;
                  font-weight: 700;
                  font-size: 24px;
                  line-height: 32px;
                ">
                Add Address
              </p>
            </div>
          </a>
          <% for (let i=0; i < Address?.address.length; i++) { %>

            <div class="selectAddress">
              <div class="form-check">
                <input value="<%=Address.address[i]._id%>" style="border: 2px solid black" class="form-check-input"
                  type="radio" name="address_id" id="flexRadioDefault<%=i+1%>" />
                <label class="form-check-label" for="flexRadioDefault<%=i+1%>">
                  <%=Address.address[i].fullname%>
                </label>
              </div>

              <p>
                <%=Address.address[i].mobile%>
              </p>
              <p>
                <%=Address.address[i].email%>
              </p>
              <p>
                <%=Address.address[i].state%>
              </p>
              <p>
                <%=Address.address[i].houseName%>
              </p>
              <p>
                <%=Address.address[i].city%>
              </p>
              <p>
                <%=Address.address[i].pin%>
              </p>
            </div>
            <% } %>
        </div>
      </div>

      <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
        <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
          <h4 class="mtext-109 cl2 p-b-30">Total Items</h4>

          <div class="flex-w flex-t bor12 p-b-13">
            <div class="size-208">
              <span class="stext-110 cl2"> Subtotal: </span>
            </div>

            <div class="size-209">
              <span class="mtext-110 cl2"> &#x20B9; <%=cartTotal%> </span>
            </div>
          </div>
          <% if (coupon) { %>
            <div class="flex-w flex-t p-t-27 p-b-33">
              <div class="size-208">
                <span class="mtext-101 cl2"> Discount: </span>
                <span >coupon added</span>
              </div>
  
              <div class="size-209 p-t-1">
                <span class="mtext-110 cl2"> &#x20B9; <%=cartTotal - totalAmount +coupon%> </span>
              </div>
            </div>
  
            <div class="flex-w flex-t p-t-27 p-b-33">
              <div class="size-208">
                <span class="mtext-101 cl2"> Total: </span>
              </div>
  
              <div class="size-209 p-t-1">
                <span class="mtext-110 cl2"> &#x20B9; <%=totalAmount - coupon%> </span>
              </div>
            </div>
        <% } else { %>
          <div class="flex-w flex-t p-t-27 p-b-33">
            <div class="size-208">
              <span class="mtext-101 cl2"> Discount: </span>
            </div>

            <div class="size-209 p-t-1">
              <span class="mtext-110 cl2"> &#x20B9; <%=cartTotal - totalAmount%> </span>
            </div>
          </div>

          <div class="flex-w flex-t p-t-27 p-b-33">
            <div class="size-208">
              <span class="mtext-101 cl2"> Total: </span>
            </div>

            <div class="size-209 p-t-1">
              <span class="mtext-110 cl2"> &#x20B9; <%=totalAmount %> </span>
            </div>
          </div>
        <% } %>
        
         
          <div class="form-check">
            <input value="COD" style="border: 2px solid black" class="form-check-input" type="radio"
              name="PaymentMethod" id="PaymentMethod1" checked />
            <label class="form-check-label" for="PaymentMethod1">
              Cash On Delivery
            </label>
          </div>
          <div class="form-check">
            <input style="border: 2px solid black" class="form-check-input" type="radio" name="PaymentMethod"
              id="PaymentMethod2" value="online_Payment" />
            <label class="form-check-label" for="PaymentMethod2">
              Online Payment
            </label>
          </div>
          <div class="form-check">
            <input style="border: 2px solid black" class="form-check-input" type="radio" name="PaymentMethod"
              id="PaymentMethod3" value="Wallet" />
            <label class="form-check-label" for="PaymentMethod3">
              Wallet
            </label>
          </div>

          <button onclick="submitForm()" type="button"
            class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
            PLACE ORDER
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  function submitForm() {
    const formData = new FormData(document.getElementById("submitOrder"));
    const urlSearchParams = new URLSearchParams(formData);

    fetch("/placeOrder", {
      method: "POST",
      body: urlSearchParams,
      headers: {
        "Content-type": "application/x-www-form-urlencoded; charset=UTF-8",
      },
    })
      .then((response) => {
        if (!response.ok) {
          console.log(response.status);
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        console.log(data);
        if (data.success) {
          window.location.href = "/orderSuccess";
        } else if (data.order) {
          razorPayment(data.order);
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message,
          });
        }
      })

      .catch((error) => {
        console.log(error);
      });
  }

  function razorPayment(order) {
    console.log(order);
    var options = {
      key: "rzp_test_2lSCohy0YKKPBl", // Enter the Key ID generated from the Dashboard
      amount: order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      currency: "INR",
      name: "ToyMania Pvt.Ltd", //your business name
      description: "Test Transaction",
      order_id: order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      handler: function (response) {
        console.log(response);

        verifyPayment(response, order);

      },
      prefill: {
        //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
        name: "ToyMania Pvt.Ltd", //your customer's name
        email: "ToyMania007store@example.com",
        contact: "910000000369", //Provide the customer's phone number for better conversion rates
      },
      notes: {
        address: "Razorpay Corporate Office",
      },
      theme: {
        color: "#c96",
      },
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();
  }

  function verifyPayment(payment, order) {
    $.ajax({
      url: "/verify-payment",
      method: "post",
      data: {
        payment: payment,
        order: order,
      },
      success: (response) => {
        if (response.success == true) {
          window.location.href = "/orderSuccess";
        } else {
          console.log('working');
          Swal.fire({
            positon: "center",
            icon: "error",
            title: "Payment failed",
            showConfirmButton: false,
            timer: 1500,
          });
        }
      },
    });
  }
</script>
<script>
  function addCoupon() {
    console.log('working');
    const formData = new FormData(document.getElementById("coupon"));
    const urlSearchParams = new URLSearchParams(formData);

    fetch("/addCoupon", {
      method: "POST",
      body: urlSearchParams,
      headers: {
        "Content-type": "application/x-www-form-urlencoded; charset=UTF-8",
      },
    })
      .then((response) => {
        if (!response.ok) {
          console.log(response.status)
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        console.log(data)
        if (data.success) {
          location.reload()
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message,
          });
        }
      })

      .catch((error) => {
        console.log(error)
      });
  }





  function removeCoupon() {
    console.log('working');
    const formData = new FormData(document.getElementById("coupon"));
    const urlSearchParams = new URLSearchParams(formData);

    fetch("/removeCoupon", {
      method: "POST",
      body: urlSearchParams,
      headers: {
        "Content-type": "application/x-www-form-urlencoded; charset=UTF-8",
      },
    })
      .then((response) => {
        if (!response.ok) {
          console.log(response.status)
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        console.log(data)
        if (data.success) {
          location.reload()
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: 'somthing wrong',
          });
        }
      })

      .catch((error) => {
        console.log(error)
      });
  }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>