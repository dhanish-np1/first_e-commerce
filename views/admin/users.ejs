<%- include('../partials/adminheadder') %>

  <!-- partial -->

  <div class="content-wrapper">
    <div class="page-header">
      <h2>fgf</h2>
    </div>
    <div class="row">
      <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Users Table</h4>
            <div class="table-responsive">
              <table class="table table-striped table-dark">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>name</th>
                    <th>number</th>
                    <th>Email</th>
                    <th>status</th>
                    <th>block</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (users.length>0) { %> <% for (var i=0; i < users.length; i++) { var user=users[i]; %>
                      <tr>
                        <td>
                          <img src="/user/images/istockphoto-1337144146-1024x1024.jpg" alt="" />
                        </td>
                        <td>
                          <%= user.fullname %>
                        </td>
                        <td>
                          <%= user.number %>
                        </td>
                        <td>
                          <%= user.email %>
                        </td>
                        <% if (user.is_block===0) { %>
                          <td>
                            <p id="status<%=user._id%>" style="color: green">active</p>
                          </td>
                          <% } else { %>
                            <td>
                              <p id="status<%=user._id%>" style="color: red">blocked</p>
                            </td>
                            <% } %>
                              <% if (user.is_block===0) { %>
                                <td>
                                  <button type="button" id="block<%=user._id%>" onclick="blockUser('<%=user._id%>')"
                                    class="btn btn-danger">Block</button>
                                </td>
                                <% } else { %>
                                  <td>
                                    <button type="button" id="block<%=user._id%>" onclick="blockUser('<%=user._id%>')"
                                      class="btn btn-success">unblock</button>
                                  </td>
                                  <% } %>
                      </tr>
                      <% } %>
                        <% } else { %>

                          <tr>
                            <td colspan="5" style="text-align: center">
                              users not found
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="display: flex; justify-content: center;">
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          <% for (let i=1; i <=totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>">
                <%= i %>
              </a>
            </li>
            <% } %>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                  <span class="sr-only">Next</span>
                </a>
              </li>
        </ul>
      </nav>
    </div>
  </div>

  <script>
    function blockUser(userId) {
      const statusCell = document.getElementById(`status${userId}`);
      const btn = document.getElementById(`block${userId}`);
      fetch(`/admin/blockuser`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ userId }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`Failed to block user with ID ${userId}`);
          }
          return response.json();
        })
        .then((data) => {
          if (data.blocked) {
            statusCell.innerHTML = data.statustext;
            statusCell.style.color = data.textcolor;
            btn.innerHTML = data.btntext;
            btn.style.backgroundColor = data.btncolor;
            btn.style.border = 0;
          } else {
            statusCell.innerHTML = data.statustext;
            statusCell.style.color = data.textcolor;
            btn.innerHTML = data.btntext;
            btn.style.backgroundColor = data.btncolor;
          }

        })

        .catch((error) => {
          console.error(error);
        });
    }
  </script>

  <%- include('../partials/adminfooter') %>